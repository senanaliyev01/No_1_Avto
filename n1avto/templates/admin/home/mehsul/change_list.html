{% extends "admin/change_list.html" %}
{% load static %}

{% block object-tools-items %}
{{ block.super }}
<li>
	<a href="#" class="addlink" id="openImportModal">Excel idxal et</a>
</li>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
	.ie-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:1000}
	.ie-modal.is-open{display:flex}
	.ie-card{background:#fff;border-radius:6px;max-width:720px;width:96%;box-shadow:0 10px 30px rgba(0,0,0,.2)}
	.ie-card .hd{padding:12px 16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
	.ie-card .bd{padding:16px}
	.ie-card .ft{padding:12px 16px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end}
	.progress{height:20px;background:#eee;border-radius:4px;overflow:hidden}
	.progress .progress-bar{height:100%;background:#2e62b4;color:#fff;text-align:center;white-space:nowrap}
	.alert{padding:8px 10px;border:1px solid #f3c5c5;background:#fdeaea;color:#6b0000;border-radius:4px}
	.table-fixed{table-layout:fixed;width:100%}
	.table-fixed th,.table-fixed td{word-break:break-word;overflow-wrap:anywhere}
	.errors-table{width:100%;border-collapse:collapse;margin-top:10px}
	.errors-table th,.errors-table td{border:1px solid #ddd;padding:8px;text-align:left}
	.errors-table th{background-color:#f5f5f5;font-weight:bold}
	.errors-table .error-row{background-color:#fff5f5}
	.errors-table .error-cell{background-color:#ffe6e6;color:#d32f2f}
	.errors-table .error-badge{background-color:#d32f2f;color:white;padding:2px 6px;border-radius:3px;font-size:11px;margin-left:5px}
	.errors-table .line-number{font-weight:bold;color:#666;text-align:center}
</style>
<script src="{% static 'js/import.js' %}"></script>
{% endblock %}

{% block content %}
{{ block.super }}

<div id="excelImportModal" class="ie-modal" aria-hidden="true">
	<div class="ie-card">
		<div class="hd">
			<h2 style="margin:0;font-size:16px">Excel idxal et</h2>
			<button type="button" class="close" id="closeImportModal" aria-label="Bağla" style="background:none;border:0;font-size:18px">×</button>
		</div>
		<div class="bd">
			<form id="excelImportForm" enctype="multipart/form-data" onsubmit="return false;">
				{% csrf_token %}
				<div class="form-row">
					<label for="excel_file">Excel faylı (.xlsx):</label>
					<input type="file" id="excel_file" name="excel_file" accept=".xlsx" />
				</div>
				<div class="form-row" style="margin-top:8px">
					<label for="batch_size">Batch ölçüsü:</label>
					<select id="batch_size" name="batch_size">
						<option value="100">100</option>
						<option value="250">250</option>
						<option value="500">500</option>
					</select>
				</div>
				<div id="importProgress" class="progress d-none" style="margin-top:10px">
					<div class="progress-bar" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100">0%</div>
				</div>
				<div id="importStatus" style="margin-top:6px" class="text-muted"></div>
				<div id="importCounters" data-new-count="0" data-update-count="0" data-error-count="0" data-deleted-count="0" style="margin-top:6px"></div>
			</form>
		</div>
		<div class="ft">
			<button class="button" type="button" id="startImportBtn">Başlat</button>
			<button class="button" type="button" id="closeImportModalFooter">Bağla</button>
		</div>
	</div>
</div>

<!-- Errors modal (Excel-like table) -->
<div id="importErrorsModal" class="ie-modal" aria-hidden="true">
	<div class="ie-card" style="max-width: 95%; width: 95%;">
		<div class="hd">
			<h2 style="margin:0;font-size:16px">İdxal xətaları</h2>
			<button type="button" class="close" id="ieCloseBtn" aria-label="Bağla" style="background:none;border:0;font-size:18px">×</button>
		</div>
		<div class="bd" style="max-height: 70vh; overflow:auto">
			<div id="errorsTableContainer">
				<!-- Excel-like table will be inserted here -->
			</div>
		</div>
		<div class="ft">
			<button class="button" type="button" id="ieCloseBtnFooter">Bağla</button>
		</div>
	</div>
</div>

<script>
(function(){
	const openBtn = document.getElementById('openImportModal');
	const dlg = document.getElementById('excelImportModal');
	const closeBtn = document.getElementById('closeImportModal');
	const closeBtnFooter = document.getElementById('closeImportModalFooter');
	if(openBtn){ openBtn.addEventListener('click', function(e){ e.preventDefault(); dlg.classList.add('is-open'); }); }
	if(closeBtn){ closeBtn.addEventListener('click', function(){ dlg.classList.remove('is-open'); }); }
	if(closeBtnFooter){ closeBtnFooter.addEventListener('click', function(){ dlg.classList.remove('is-open'); }); }
	if(dlg){ dlg.addEventListener('click', function(e){ if(e.target === dlg){ dlg.classList.remove('is-open'); } }); }
})();
</script>

{% endblock %} 